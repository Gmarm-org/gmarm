# üìä **Archivos de Base de Datos - GMARM**

Este directorio contiene los archivos SQL necesarios para configurar la base de datos del sistema GMARM.

## üìÅ **Archivos Incluidos**

### 1. **`gmarm_schema_mejorado.sql`**
- **Descripci√≥n**: Esquema completo de la base de datos con todas las mejoras implementadas
- **Contenido**:
  - Todas las tablas del sistema
  - √çndices para optimizar consultas
  - Constraints de validaci√≥n
  - Triggers para auditor√≠a autom√°tica
  - Relaciones y foreign keys

### 2. **`gmarm_datos_prueba.sql`**
- **Descripci√≥n**: Datos de prueba para desarrollo y testing
- **Contenido**:
  - Cat√°logos iniciales (tipos de cliente, identificaci√≥n, proceso, etc.)
  - Usuarios de prueba con diferentes roles
  - Licencias de importaci√≥n
  - Modelos de armas del cat√°logo CZ
  - Clientes de ejemplo (civil, militar, empresa)
  - Grupos de importaci√≥n de prueba
  - Asignaciones de armas
  - Respuestas de clientes
  - Notificaciones y documentos generados

## üöÄ **Instrucciones de Uso**

### **Para Desarrollo Local:**

1. **Crear la base de datos:**
   ```sql
   CREATE DATABASE gmarm_dev;
   ```

2. **Ejecutar el esquema:**
   ```bash
   psql -U tu_usuario -d gmarm_dev -f gmarm_schema_mejorado.sql
   ```

3. **Cargar datos de prueba:**
   ```bash
   psql -U tu_usuario -d gmarm_dev -f gmarm_datos_prueba.sql
   ```

### **Para Docker (usando docker-compose):**

1. **Iniciar los servicios:**
   ```bash
   docker-compose -f docker-compose.dev.yml up -d postgres_dev
   ```

2. **Esperar a que PostgreSQL est√© listo (30-60 segundos)**

3. **Ejecutar los scripts:**
   ```bash
   # Conectar al contenedor
   docker exec -it postgres_dev psql -U devuser -d devdb
   
   # Dentro de psql, ejecutar:
   \i /path/to/gmarm_schema_mejorado.sql
   \i /path/to/gmarm_datos_prueba.sql
   ```

### **Para Producci√≥n:**

1. **Crear la base de datos de producci√≥n:**
   ```sql
   CREATE DATABASE gmarm_prod;
   ```

2. **Ejecutar solo el esquema (sin datos de prueba):**
   ```bash
   psql -U tu_usuario -d gmarm_prod -f gmarm_schema_mejorado.sql
   ```

## üîß **Configuraci√≥n de la Aplicaci√≥n**

### **application.properties:**
```properties
# Base de datos
spring.datasource.url=jdbc:postgresql://localhost:5432/gmarm_dev
spring.datasource.username=devuser
spring.datasource.password=devpass
spring.datasource.driver-class-name=org.postgresql.Driver

# JPA/Hibernate
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect

# Auditor√≠a
spring.data.jpa.repositories.enabled=true
spring.jpa.properties.hibernate.jdbc.time_zone=UTC
```

## üë• **Usuarios de Prueba**

### **Credenciales de Acceso:**

| Usuario | Contrase√±a | Rol | Descripci√≥n |
|---------|------------|-----|-------------|
| `admin` | `admin123` | Administrador | Acceso completo al sistema |
| `vendedor1` | `admin123` | Vendedor | Gesti√≥n de clientes y armas |
| `vendedor2` | `admin123` | Vendedor | Gesti√≥n de clientes y armas |
| `direccion_ventas` | `admin123` | Direcci√≥n de Ventas | Aprobaci√≥n de solicitudes |
| `operaciones` | `admin123` | Operaciones | Gesti√≥n de importaci√≥n |
| `finanzas` | `admin123` | Finanzas | Gesti√≥n de pagos |

## üìã **Estructura de Datos**

### **Tablas Principales:**
- **`usuario`** - Usuarios del sistema
- **`rol`** - Roles y permisos
- **`cliente`** - Clientes del sistema
- **`tipo_cliente`** - Cat√°logo de tipos de cliente
- **`tipo_identificacion`** - Cat√°logo de tipos de identificaci√≥n
- **`modelo_arma`** - Cat√°logo de modelos de armas
- **`asignacion_arma`** - Asignaciones de armas a clientes
- **`grupo_importacion`** - Grupos de importaci√≥n
- **`licencia`** - Licencias de importaci√≥n

### **Mejoras Implementadas:**
- ‚úÖ **Campos de ubicaci√≥n** (provincia, canton)
- ‚úÖ **Campos para empresas** (RUC, nombre_empresa, etc.)
- ‚úÖ **Estado militar** para uniformados
- ‚úÖ **Auditor√≠a completa** con fechas de creaci√≥n/modificaci√≥n
- ‚úÖ **Constraints de validaci√≥n** (edad m√≠nima, formato email, etc.)
- ‚úÖ **Triggers autom√°ticos** para auditor√≠a
- ‚úÖ **√çndices optimizados** para consultas frecuentes

## üîç **Consultas √ötiles**

### **Verificar la instalaci√≥n:**
```sql
-- Contar usuarios
SELECT COUNT(*) FROM usuario;

-- Contar clientes
SELECT COUNT(*) FROM cliente;

-- Ver tipos de cliente
SELECT * FROM tipo_cliente WHERE estado = true;

-- Ver modelos de armas
SELECT * FROM modelo_arma WHERE estado = 'DISPONIBLE';
```

### **Estad√≠sticas b√°sicas:**
```sql
-- Clientes por tipo
SELECT tc.nombre, COUNT(c.id) 
FROM cliente c 
JOIN tipo_cliente tc ON c.tipo_cliente_id = tc.id 
GROUP BY tc.nombre;

-- Usuarios por rol
SELECT r.nombre, COUNT(ur.usuario_id) 
FROM usuario_rol ur 
JOIN rol r ON ur.rol_id = r.id 
GROUP BY r.nombre;
```

## ‚ö†Ô∏è **Notas Importantes**

1. **Contrase√±as**: Todos los usuarios de prueba tienen la contrase√±a `admin123` (hasheada con BCrypt)
2. **Datos de prueba**: Los datos incluidos son solo para desarrollo, no usar en producci√≥n
3. **Backup**: Siempre hacer backup antes de ejecutar scripts en bases de datos existentes
4. **Permisos**: Asegurarse de que el usuario de la base de datos tenga permisos suficientes

## üÜò **Soluci√≥n de Problemas**

### **Error de conexi√≥n:**
```bash
# Verificar que PostgreSQL est√© corriendo
docker ps | grep postgres

# Verificar logs
docker logs postgres_dev
```

### **Error de permisos:**
```sql
-- Conectar como superusuario y otorgar permisos
GRANT ALL PRIVILEGES ON DATABASE gmarm_dev TO devuser;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO devuser;
```

### **Error de constraints:**
```sql
-- Verificar constraints existentes
SELECT conname, contype, pg_get_constraintdef(oid) 
FROM pg_constraint 
WHERE conrelid = 'cliente'::regclass;
```

---

**¬°Los archivos est√°n listos para usar!** üéâ 