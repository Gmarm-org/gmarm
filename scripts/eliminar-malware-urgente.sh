#!/bin/bash

# üö® SCRIPT DE EMERGENCIA: Eliminar Malware/Cryptominers
# Fecha: 2025-11-10
# Uso: sudo bash eliminar-malware-urgente.sh

set -e

echo "üö® ========================================="
echo "üö® ELIMINACI√ìN DE MALWARE - URGENTE"
echo "üö® ========================================="
echo ""

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Verificar que se ejecuta como root
if [ "$EUID" -ne 0 ]; then 
  echo -e "${RED}‚ùå ERROR: Este script debe ejecutarse con sudo${NC}"
  exit 1
fi

echo -e "${YELLOW}üîç Paso 1: Identificando procesos maliciosos...${NC}"
echo ""

# Buscar procesos sospechosos
MYSQL_PROCS=$(ps aux | grep -E "[m]ysql" | grep -v grep || true)
KDEVTMPFSI_PROCS=$(ps aux | grep -E "[k]devtmpfsi" | grep -v grep || true)

if [ -z "$MYSQL_PROCS" ] && [ -z "$KDEVTMPFSI_PROCS" ]; then
  echo -e "${GREEN}‚úÖ No se encontraron procesos maliciosos activos${NC}"
else
  echo -e "${RED}‚ö†Ô∏è  PROCESOS MALICIOSOS DETECTADOS:${NC}"
  echo ""
  
  if [ -n "$MYSQL_PROCS" ]; then
    echo -e "${RED}Procesos 'mysql' sospechosos:${NC}"
    echo "$MYSQL_PROCS"
    echo ""
  fi
  
  if [ -n "$KDEVTMPFSI_PROCS" ]; then
    echo -e "${RED}Procesos 'kdevtmpfsi' (cryptominer):${NC}"
    echo "$KDEVTMPFSI_PROCS"
    echo ""
  fi
fi

echo ""
echo -e "${YELLOW}üíÄ Paso 2: Matando procesos maliciosos...${NC}"

# Matar procesos mysql
MYSQL_COUNT=$(pkill -9 mysql 2>/dev/null; echo $?)
if [ "$MYSQL_COUNT" -eq 0 ]; then
  echo -e "${GREEN}‚úÖ Procesos 'mysql' eliminados${NC}"
else
  echo -e "${YELLOW}‚ö†Ô∏è  No se encontraron procesos 'mysql' activos${NC}"
fi

# Matar procesos kdevtmpfsi
KDEVTMPFSI_COUNT=$(pkill -9 kdevtmpfsi 2>/dev/null; echo $?)
if [ "$KDEVTMPFSI_COUNT" -eq 0 ]; then
  echo -e "${GREEN}‚úÖ Procesos 'kdevtmpfsi' eliminados${NC}"
else
  echo -e "${YELLOW}‚ö†Ô∏è  No se encontraron procesos 'kdevtmpfsi' activos${NC}"
fi

echo ""
echo -e "${YELLOW}üîç Paso 3: Buscando binarios maliciosos...${NC}"
echo ""

# Buscar binarios en ubicaciones comunes de malware
LOCATIONS=(
  "/tmp"
  "/var/tmp"
  "/dev/shm"
  "/home/*/tmp"
  "/home/*/.cache"
  "/root/.cache"
)

FOUND_FILES=()

for location in "${LOCATIONS[@]}"; do
  echo -e "${YELLOW}  Buscando en: $location${NC}"
  
  # Buscar mysql
  MYSQL_FILES=$(find $location -name "*mysql*" -type f 2>/dev/null || true)
  if [ -n "$MYSQL_FILES" ]; then
    FOUND_FILES+=($MYSQL_FILES)
  fi
  
  # Buscar kdevtmpfsi
  KDEVTMPFSI_FILES=$(find $location -name "*kdevtmpfsi*" -type f 2>/dev/null || true)
  if [ -n "$KDEVTMPFSI_FILES" ]; then
    FOUND_FILES+=($KDEVTMPFSI_FILES)
  fi
done

if [ ${#FOUND_FILES[@]} -eq 0 ]; then
  echo -e "${GREEN}‚úÖ No se encontraron binarios maliciosos${NC}"
else
  echo -e "${RED}‚ö†Ô∏è  ARCHIVOS MALICIOSOS ENCONTRADOS:${NC}"
  for file in "${FOUND_FILES[@]}"; do
    echo "  - $file"
  done
  
  echo ""
  read -p "¬øDesea eliminar estos archivos? (s/N): " -n 1 -r
  echo
  if [[ $REPLY =~ ^[SsYy]$ ]]; then
    for file in "${FOUND_FILES[@]}"; do
      rm -rf "$file"
      echo -e "${GREEN}  ‚úÖ Eliminado: $file${NC}"
    done
  else
    echo -e "${YELLOW}‚ö†Ô∏è  Archivos NO eliminados (ejecuci√≥n manual requerida)${NC}"
  fi
fi

echo ""
echo -e "${YELLOW}üîç Paso 4: Verificando crontabs sospechosos...${NC}"
echo ""

# Verificar crontab del root
CRON_ROOT=$(crontab -l 2>/dev/null | grep -E "mysql|kdevtmpfsi|curl.*sh" || true)
if [ -n "$CRON_ROOT" ]; then
  echo -e "${RED}‚ö†Ô∏è  CRONTAB ROOT SOSPECHOSO:${NC}"
  echo "$CRON_ROOT"
  echo ""
  echo -e "${YELLOW}‚ö†Ô∏è  Revisar y eliminar manualmente: crontab -e${NC}"
else
  echo -e "${GREEN}‚úÖ Crontab root limpio${NC}"
fi

# Verificar crontabs de usuarios
for user in $(cut -f1 -d: /etc/passwd); do
  CRON_USER=$(crontab -u $user -l 2>/dev/null | grep -E "mysql|kdevtmpfsi|curl.*sh" || true)
  if [ -n "$CRON_USER" ]; then
    echo -e "${RED}‚ö†Ô∏è  CRONTAB DE $user SOSPECHOSO:${NC}"
    echo "$CRON_USER"
    echo ""
  fi
done

echo ""
echo -e "${YELLOW}üîç Paso 5: Verificando servicios systemd...${NC}"
echo ""

SYSTEMD_SERVICES=$(systemctl list-units | grep -E "mysql|kdevtmpfsi" || true)
if [ -n "$SYSTEMD_SERVICES" ]; then
  echo -e "${RED}‚ö†Ô∏è  SERVICIOS SYSTEMD SOSPECHOSOS:${NC}"
  echo "$SYSTEMD_SERVICES"
else
  echo -e "${GREEN}‚úÖ No se encontraron servicios systemd maliciosos${NC}"
fi

echo ""
echo -e "${YELLOW}üîç Paso 6: Verificando conexiones de red sospechosas...${NC}"
echo ""

# Verificar conexiones ESTABLISHED
SUSPICIOUS_CONNECTIONS=$(netstat -tunp 2>/dev/null | grep ESTABLISHED | grep -E "mysql|kdevtmpfsi" || true)
if [ -n "$SUSPICIOUS_CONNECTIONS" ]; then
  echo -e "${RED}‚ö†Ô∏è  CONEXIONES SOSPECHOSAS:${NC}"
  echo "$SUSPICIOUS_CONNECTIONS"
else
  echo -e "${GREEN}‚úÖ No se detectaron conexiones sospechosas activas${NC}"
fi

echo ""
echo "========================================="
echo "üìä RESUMEN"
echo "========================================="
echo ""
echo -e "${GREEN}‚úÖ Procesos maliciosos eliminados${NC}"
echo -e "${GREEN}‚úÖ Verificaci√≥n de binarios completada${NC}"
echo -e "${GREEN}‚úÖ Verificaci√≥n de crontabs completada${NC}"
echo -e "${GREEN}‚úÖ Verificaci√≥n de servicios completada${NC}"
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  RECOMENDACIONES:${NC}"
echo "  1. Ejecutar nuevamente en 5 minutos para verificar que no reaparecen"
echo "  2. Revisar manualmente crontabs: crontab -e"
echo "  3. Cambiar contrase√±as de todos los usuarios"
echo "  4. Actualizar sistema: apt update && apt upgrade"
echo "  5. Considerar reinstalaci√≥n si el problema persiste"
echo ""
echo -e "${GREEN}‚úÖ LIMPIEZA COMPLETADA${NC}"
echo ""

