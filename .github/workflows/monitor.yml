name: ðŸ” GMARM Monitoring & Alerts

on:
  schedule:
    # Ejecutar cada 30 minutos para monitoreo
    - cron: '*/30 * * * *'
  workflow_dispatch:  # Permitir ejecuciÃ³n manual

env:
  BACKEND_PROD_URL: "https://api.gmarm.com"
  FRONTEND_PROD_URL: "https://gmarm.com"

jobs:
  # ========================================
  # JOB: HEALTH MONITORING - SOLO PRODUCCIÃ“N
  # ========================================
  health-check:
    name: ðŸ¥ Health Check - Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ¥ Check Backend Health
        id: backend-health
        run: |
          URL="${{ env.BACKEND_PROD_URL }}/api/health"
          
          echo "ðŸ” Checking backend health: $URL"
          
          if curl -f -s --max-time 30 "$URL" > /dev/null; then
            echo "âœ… Backend is healthy"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "âŒ Backend is unhealthy"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi
          
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: ðŸŒ Check Frontend Availability
        id: frontend-health
        run: |
          URL="${{ env.FRONTEND_PROD_URL }}"
          
          echo "ðŸ” Checking frontend availability: $URL"
          
          if curl -f -s --max-time 30 "$URL" > /dev/null; then
            echo "âœ… Frontend is available"
            echo "status=available" >> $GITHUB_OUTPUT
          else
            echo "âŒ Frontend is unavailable"
            echo "status=unavailable" >> $GITHUB_OUTPUT
          fi
          
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Health Summary
        run: |
          echo "## ðŸ¥ Health Check - Production" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.backend-health.outputs.status == 'healthy' && 'âœ… Healthy' || 'âŒ Unhealthy' }} | ${{ steps.backend-health.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.frontend-health.outputs.status == 'available' && 'âœ… Available' || 'âŒ Unavailable' }} | ${{ steps.frontend-health.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.backend-health.outputs.status }}" != "healthy" ] || [ "${{ steps.frontend-health.outputs.status }}" != "available" ]; then
            echo "âš ï¸ **Issues detected in production**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ========================================
  # JOB: PERFORMANCE MONITORING - SOLO PRODUCCIÃ“N
  # ========================================
  performance-check:
    name: âš¡ Performance Check - Production
    runs-on: ubuntu-latest
    needs: health-check
    
    steps:
      - name: âš¡ Backend Response Time
        id: backend-perf
        run: |
          # Check production environment only
          PROD_TIME=$(curl -w "%{time_total}" -s -o /dev/null "${{ env.BACKEND_PROD_URL }}/api/health" || echo "999")
          
          echo "ðŸ• Production response time: ${PROD_TIME}s"
          
          echo "prod-time=$PROD_TIME" >> $GITHUB_OUTPUT
          
          # Alert if response time is too high (> 3 seconds)
          if (( $(echo "$PROD_TIME > 3" | bc -l) )); then
            echo "âš ï¸ Production backend is slow: ${PROD_TIME}s"
            echo "prod-slow=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Performance Summary
        run: |
          echo "## âš¡ Performance Check - Production" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Response Time | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.backend-perf.outputs.prod-time }}s | ${{ steps.backend-perf.outputs.prod-slow == 'true' && 'âš ï¸ Slow' || 'âœ… OK' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.backend-perf.outputs.prod-slow }}" = "true" ]; then
            echo "âš ï¸ **Performance issues detected**" >> $GITHUB_STEP_SUMMARY
          fi

  # ========================================
  # JOB: ALERT ON FAILURES - SOLO LOGS (SIN CREAR ISSUES)
  # ========================================
  alert:
    name: ðŸš¨ Alert Summary
    runs-on: ubuntu-latest
    needs: [health-check, performance-check]
    if: always() && (needs.health-check.result == 'failure' || needs.performance-check.result == 'failure')
    
    steps:
      - name: ðŸš¨ Log Critical Problems
        if: needs.health-check.result == 'failure'
        run: |
          echo "## ðŸš¨ Critical Health Issues Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Required:" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH al servidor y verificar servicios" >> $GITHUB_STEP_SUMMARY
          echo "2. Ejecutar: \`docker ps\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Ver logs: \`docker-compose -f docker-compose.prod.yml logs\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Verificar conectividad de red" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Verifica manualmente el servidor de producciÃ³n**" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¢ Performance Alert
        if: needs.performance-check.result == 'failure'
        run: |
          echo "## âš ï¸ Performance Issues" >> $GITHUB_STEP_SUMMARY
          echo "Backend response time is above acceptable threshold" >> $GITHUB_STEP_SUMMARY
          echo "Consider investigating server resources and database performance" >> $GITHUB_STEP_SUMMARY
