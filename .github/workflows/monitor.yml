name: ðŸ” GMARM Monitoring & Alerts (Solo Alertas - Manual)

on:
  # Schedule desactivado - Solo alertar cuando hay errores manualmente o mediante integraciÃ³n externa
  # schedule:
  #   - cron: '0 6,18 * * *'
  workflow_dispatch:  # Permitir ejecuciÃ³n manual cuando sea necesario

env:
  BACKEND_PROD_URL: "https://api.gmarm.com"
  FRONTEND_PROD_URL: "https://gmarm.com"

jobs:
  # ========================================
  # JOB: HEALTH MONITORING - SOLO PRODUCCIÃ“N
  # ========================================
  health-check:
    name: ðŸ¥ Health Check - Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ¥ Check Backend Health
        id: backend-health
        run: |
          URL="${{ env.BACKEND_PROD_URL }}/api/health"
          
          if curl -f -s --max-time 30 "$URL" > /dev/null; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            # No mostrar ningÃºn log cuando estÃ¡ saludable
          else
            echo "âŒ ALERTA: Backend no responde en $URL" >&2
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi
          
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: ðŸŒ Check Frontend Availability
        id: frontend-health
        run: |
          URL="${{ env.FRONTEND_PROD_URL }}"
          
          if curl -f -s --max-time 30 "$URL" > /dev/null; then
            echo "status=available" >> $GITHUB_OUTPUT
            # No mostrar ningÃºn log cuando estÃ¡ disponible
          else
            echo "âŒ ALERTA: Frontend no disponible en $URL" >&2
            echo "status=unavailable" >> $GITHUB_OUTPUT
          fi
          
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Health Summary (Solo si hay fallos)
        if: steps.backend-health.outputs.status != 'healthy' || steps.frontend-health.outputs.status != 'available'
        run: |
          echo "## ðŸš¨ ALERTA: Problemas Detectados en ProducciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Servicio | Estado | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.backend-health.outputs.status == 'healthy' && 'âœ… OK' || 'âŒ FALLO' }} | ${{ steps.backend-health.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.frontend-health.outputs.status == 'available' && 'âœ… OK' || 'âŒ FALLO' }} | ${{ steps.frontend-health.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ AcciÃ³n Requerida" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH al servidor: \`ssh ubuntu@72.167.52.14\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Verificar contenedores: \`docker ps\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Ver logs: \`docker-compose -f docker-compose.prod.yml logs --tail=50\`" >> $GITHUB_STEP_SUMMARY
          exit 1

  # ========================================
  # JOB: PERFORMANCE MONITORING - SOLO PRODUCCIÃ“N
  # ========================================
  performance-check:
    name: âš¡ Performance Check - Production
    runs-on: ubuntu-latest
    needs: health-check
    if: always()
    
    steps:
      - name: âš¡ Backend Response Time
        id: backend-perf
        run: |
          # Check production environment only
          PROD_TIME=$(curl -w "%{time_total}" -s -o /dev/null "${{ env.BACKEND_PROD_URL }}/api/health" || echo "999")
          
          echo "prod-time=$PROD_TIME" >> $GITHUB_OUTPUT
          
          # Alert if response time is too high (> 3 seconds)
          if (( $(echo "$PROD_TIME > 3" | bc -l) )); then
            echo "âš ï¸ ALERTA: Backend lento - ${PROD_TIME}s (lÃ­mite: 3s)" >&2
            echo "prod-slow=true" >> $GITHUB_OUTPUT
          else
            echo "prod-slow=false" >> $GITHUB_OUTPUT
            # No mostrar ningÃºn log cuando el performance es aceptable
          fi

      - name: ðŸ“Š Performance Summary (Solo si hay problemas)
        if: steps.backend-perf.outputs.prod-slow == 'true'
        run: |
          echo "## âš ï¸ ALERTA: Problemas de Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Servicio | Tiempo de Respuesta | LÃ­mite | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------------------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.backend-perf.outputs.prod-time }}s | 3s | âš ï¸ LENTO |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Investigar" >> $GITHUB_STEP_SUMMARY
          echo "1. Verificar uso de CPU/Memoria: \`docker stats\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Revisar queries lentas en PostgreSQL" >> $GITHUB_STEP_SUMMARY
          echo "3. Verificar conexiones a BD: \`SELECT count(*) FROM pg_stat_activity;\`" >> $GITHUB_STEP_SUMMARY
          exit 1

  # ========================================
  # JOB: ALERT ON FAILURES - SOLO SE EJECUTA SI HAY FALLOS (MITIGACIÃ“N)
  # ========================================
  alert:
    name: ðŸš¨ Alert Summary (Solo si hay fallos - Ejecutar mitigaciÃ³n)
    runs-on: ubuntu-latest
    needs: [health-check, performance-check]
    if: always() && (needs.health-check.result == 'failure' || needs.performance-check.result == 'failure')
    
    steps:
      - name: ðŸš¨ Log Critical Problems & Mitigation Steps
        if: needs.health-check.result == 'failure'
        run: |
          echo "## ðŸš¨ Critical Health Issues Detected - AcciÃ³n Requerida" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Pasos de MitigaciÃ³n Inmediata:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Conectar al servidor:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   ssh ubuntu@72.167.52.14" >> $GITHUB_STEP_SUMMARY
          echo "   cd ~/deploy/prod" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Verificar estado de contenedores:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   docker ps -a" >> $GITHUB_STEP_SUMMARY
          echo "   docker stats --no-stream" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Revisar logs recientes:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   docker-compose -f docker-compose.prod.yml logs --tail=100 backend" >> $GITHUB_STEP_SUMMARY
          echo "   docker-compose -f docker-compose.prod.yml logs --tail=50 postgres_prod" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "4. **Reiniciar servicios si es necesario:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   docker-compose -f docker-compose.prod.yml restart backend" >> $GITHUB_STEP_SUMMARY
          echo "   # O si el backend estÃ¡ caÃ­do:" >> $GITHUB_STEP_SUMMARY
          echo "   docker-compose -f docker-compose.prod.yml up -d backend" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "5. **Verificar conectividad:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   curl http://localhost:8080/api/health" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Ejecutar estos pasos en orden hasta identificar y resolver el problema**" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¢ Performance Alert & Mitigation
        if: needs.performance-check.result == 'failure'
        run: |
          echo "## âš ï¸ Performance Issues - AcciÃ³n Requerida" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "Backend response time is above acceptable threshold (>3s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Pasos de MitigaciÃ³n:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Verificar recursos del servidor:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   ssh ubuntu@72.167.52.14" >> $GITHUB_STEP_SUMMARY
          echo "   docker stats --no-stream" >> $GITHUB_STEP_SUMMARY
          echo "   top" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Revisar queries lentas en PostgreSQL:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   docker exec gmarm-postgres-prod psql -U postgres -d gmarm_prod -c \"SELECT query, state, wait_event_type FROM pg_stat_activity WHERE state != 'idle';\"" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Limpiar conexiones inactivas si hay muchas:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`sql" >> $GITHUB_STEP_SUMMARY
          echo "   SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'gmarm_prod' AND state = 'idle' AND state_change < now() - interval '10 minutes';" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "4. **Reiniciar backend si es necesario:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   docker-compose -f docker-compose.prod.yml restart backend" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
