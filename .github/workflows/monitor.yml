name: üîç GMARM Monitoring & Alerts

on:
  schedule:
    # Ejecutar cada 30 minutos para monitoreo
    - cron: '*/30 * * * *'
  workflow_dispatch:  # Permitir ejecuci√≥n manual

env:
  BACKEND_DEV_URL: "http://72.167.52.14:8080"
  FRONTEND_DEV_URL: "http://72.167.52.14:5173"
  BACKEND_PROD_URL: "https://gmarm.com"
  FRONTEND_PROD_URL: "https://gmarm.com"

jobs:
  # ========================================
  # JOB: HEALTH MONITORING
  # ========================================
  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        environment: [development, production]
    
    steps:
      - name: üè• Check Backend Health
        id: backend-health
        run: |
          if [ "${{ matrix.environment }}" = "development" ]; then
            URL="${{ env.BACKEND_DEV_URL }}/api/health"
          else
            URL="${{ env.BACKEND_PROD_URL }}/api/health"
          fi
          
          echo "üîç Checking backend health: $URL"
          
          if curl -f -s --max-time 30 "$URL" > /dev/null; then
            echo "‚úÖ Backend is healthy"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Backend is unhealthy"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi
          
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: üåê Check Frontend Availability
        id: frontend-health
        run: |
          if [ "${{ matrix.environment }}" = "development" ]; then
            URL="${{ env.FRONTEND_DEV_URL }}"
          else
            URL="${{ env.FRONTEND_PROD_URL }}"
          fi
          
          echo "üîç Checking frontend availability: $URL"
          
          if curl -f -s --max-time 30 "$URL" > /dev/null; then
            echo "‚úÖ Frontend is available"
            echo "status=available" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Frontend is unavailable"
            echo "status=unavailable" >> $GITHUB_OUTPUT
          fi
          
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: üìä Health Summary
        run: |
          echo "## üè• Health Check - ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.backend-health.outputs.status == 'healthy' && '‚úÖ Healthy' || '‚ùå Unhealthy' }} | ${{ steps.backend-health.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.frontend-health.outputs.status == 'available' && '‚úÖ Available' || '‚ùå Unavailable' }} | ${{ steps.frontend-health.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.backend-health.outputs.status }}" != "healthy" ] || [ "${{ steps.frontend-health.outputs.status }}" != "available" ]; then
            echo "‚ö†Ô∏è **Issues detected in ${{ matrix.environment }}**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ========================================
  # JOB: PERFORMANCE MONITORING
  # ========================================
  performance-check:
    name: ‚ö° Performance Check
    runs-on: ubuntu-latest
    needs: health-check
    
    steps:
      - name: ‚ö° Backend Response Time
        id: backend-perf
        run: |
          # Check development environment
          DEV_TIME=$(curl -w "%{time_total}" -s -o /dev/null "${{ env.BACKEND_DEV_URL }}/api/health" || echo "999")
          PROD_TIME=$(curl -w "%{time_total}" -s -o /dev/null "${{ env.BACKEND_PROD_URL }}/api/health" || echo "999")
          
          echo "üïê Development response time: ${DEV_TIME}s"
          echo "üïê Production response time: ${PROD_TIME}s"
          
          echo "dev-time=$DEV_TIME" >> $GITHUB_OUTPUT
          echo "prod-time=$PROD_TIME" >> $GITHUB_OUTPUT
          
          # Alert if response time is too high
          if (( $(echo "$DEV_TIME > 5" | bc -l) )); then
            echo "‚ö†Ô∏è Development backend is slow: ${DEV_TIME}s"
            echo "dev-slow=true" >> $GITHUB_OUTPUT
          fi
          
          if (( $(echo "$PROD_TIME > 3" | bc -l) )); then
            echo "‚ö†Ô∏è Production backend is slow: ${PROD_TIME}s"
            echo "prod-slow=true" >> $GITHUB_OUTPUT
          fi

      - name: üìä Performance Summary
        run: |
          echo "## ‚ö° Performance Check" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Response Time | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Development | ${{ steps.backend-perf.outputs.dev-time }}s | ${{ steps.backend-perf.outputs.dev-slow == 'true' && '‚ö†Ô∏è Slow' || '‚úÖ OK' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production | ${{ steps.backend-perf.outputs.prod-time }}s | ${{ steps.backend-perf.outputs.prod-slow == 'true' && '‚ö†Ô∏è Slow' || '‚úÖ OK' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.backend-perf.outputs.dev-slow }}" = "true" ] || [ "${{ steps.backend-perf.outputs.prod-slow }}" = "true" ]; then
            echo "‚ö†Ô∏è **Performance issues detected**" >> $GITHUB_STEP_SUMMARY
          fi

  # ========================================
  # JOB: ALERT ON FAILURES
  # ========================================
  alert:
    name: üö® Alert on Issues
    runs-on: ubuntu-latest
    needs: [health-check, performance-check]
    if: always() && (needs.health-check.result == 'failure' || needs.performance-check.result == 'failure')
    
    steps:
      - name: üö® Create Issue for Critical Problems
        if: needs.health-check.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Critical: Service Health Issues Detected - ${new Date().toISOString()}`;
            const body = `
            ## üö® Critical Health Issues Detected
            
            **Time:** ${new Date().toISOString()}
            **Environment:** Development and/or Production
            
            ### Issues:
            - One or more services are unhealthy
            - Backend or Frontend is not responding
            
            ### Actions Required:
            1. Check server logs
            2. Verify Docker containers are running
            3. Check database connectivity
            4. Verify network connectivity
            
            ### Quick Commands:
            \`\`\`bash
            # Check Docker status
            docker ps
            
            # Check logs
            docker-compose -f docker-compose.dev.yml logs
            
            # Restart services
            docker-compose -f docker-compose.dev.yml restart
            \`\`\`
            
            ---
            *This issue was automatically created by the monitoring workflow.*
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['critical', 'monitoring', 'health-check']
            });

      - name: üì¢ Performance Alert
        if: needs.performance-check.result == 'failure'
        run: |
          echo "‚ö†Ô∏è Performance issues detected but not critical enough for automatic issue creation"
          echo "Consider investigating if performance issues persist"
