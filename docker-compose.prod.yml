services:
  backend:
    build: ./backend
    image: gmarm-backend-prod
    container_name: gmarm-backend-prod
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres_prod:5432/${POSTGRES_DB:-gmarm_prod}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-postgres}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
      - APP_JWT_SECRET=${JWT_SECRET}
      - APP_JWT_EXPIRATION=86400000
      # üîí CORS en producci√≥n (SOLO dominios permitidos - NO incluir api.gmarm.com)
      - SPRING_CORS_ALLOWED_ORIGINS=https://gmarm.com,https://www.gmarm.com
      - SPRING_CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,OPTIONS
      - SPRING_CORS_ALLOWED_HEADERS=*
      # üìß Configuraci√≥n de Email (OBLIGATORIO)
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_FROM=${MAIL_FROM:-noreply@gmarm.com}
      # Configuraci√≥n JVM optimizada para producci√≥n (768MB l√≠mite)
      - JAVA_OPTS=-Xms256m -Xmx640m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:MaxMetaspaceSize=128m -XX:+UseStringDeduplication -XX:+UseCompressedOops
    depends_on:
      postgres_prod:
        condition: service_healthy  # ‚úÖ Esperar a que PostgreSQL est√© healthy
    volumes:
      - ./uploads:/app/uploads
      - ./documentacion:/app/documentacion
      - ./logs:/app/logs  # Logs del backend para an√°lisis
    restart: unless-stopped
    networks:
      - gmarm-network
    # üî• PRODUCCI√ìN: 768MB para Backend (DEV apagado, toda la RAM disponible)
    mem_limit: 768m
    mem_reservation: 384m
    cpus: 1.5
    # üîí Seguridad: Usuario no-root (TEMPORALMENTE DESHABILITADO por permisos de logs)
    # user: "1000:1000"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-https://api.gmarm.com}
    image: gmarm-frontend-prod
    container_name: gmarm-frontend-prod
    ports:
      - "3000:80"  # Puerto interno 3000 (Nginx hace proxy desde 80/443)
    environment:
      - VITE_API_BASE_URL=${API_URL:-https://api.gmarm.com}
      - VITE_APP_NAME=Sistema GMARM - Importaci√≥n de Armas
      - VITE_DEV_MODE=false
      - NODE_ENV=production
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - gmarm-network
    # üî• PRODUCCI√ìN: 384MB para Frontend (archivos est√°ticos)
    mem_limit: 384m
    mem_reservation: 192m
    cpus: 0.5
    # üîí Seguridad: Usuario no-root (TEMPORALMENTE DESHABILITADO)
    # user: "1000:1000"
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  postgres_prod:
    image: postgres:15-alpine
    container_name: gmarm-postgres-prod
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-gmarm_prod}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}  # ‚úÖ OBLIGATORIO desde .env
      # Configuraci√≥n para inicializaci√≥n limpia
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    ports:
      - "5432:5432"  # Puerto est√°ndar en producci√≥n
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
      - ./datos/00_gmarm_completo.sql:/docker-entrypoint-initdb.d/00_gmarm_completo.sql
      - ./scripts/ensure-db-exists.sh:/docker-entrypoint-initdb.d/ensure-db-exists.sh
      - ./scripts/init-db.sh:/docker-entrypoint-initdb.d/zzz-verify.sh
    command:
      - "postgres"
      - "-c"
      - "listen_addresses=*"
      - "-c"
      - "max_connections=50"                    # Incrementado para producci√≥n
      - "-c"
      - "shared_buffers=640MB"                  # 25% de 2.5GB RAM
      - "-c"
      - "work_mem=8MB"                          # Mayor para queries complejas
      - "-c"
      - "maintenance_work_mem=160MB"            # Mayor para VACUUM, ANALYZE
      - "-c"
      - "effective_cache_size=1.8GB"            # ~72% de 2.5GB disponible
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "random_page_cost=1.1"                  # Optimizado para SSD
      - "-c"
      - "effective_io_concurrency=200"          # Para SSD
      - "-c"
      - "autovacuum=on"
      - "-c"
      - "autovacuum_max_workers=2"              # 2 workers para producci√≥n
      - "-c"
      - "autovacuum_naptime=300s"               # Cada 5 minutos
      - "-c"
      - "autovacuum_work_mem=64MB"              # Mayor para autovacuum
      - "-c"
      - "log_min_duration_statement=2000"       # Log queries > 2s
      - "-c"
      - "log_line_prefix=%t [%p]: user=%u,db=%d,client=%h "
      - "-c"
      - "log_checkpoints=on"
      - "-c"
      - "log_connections=on"                    # ‚úÖ Log conexiones en PROD
      - "-c"
      - "log_disconnections=on"                 # ‚úÖ Log desconexiones en PROD
      - "-c"
      - "log_lock_waits=on"                     # ‚úÖ Log deadlocks
      - "-c"
      - "log_temp_files=10240"                  # Log archivos temp > 10MB
      - "-c"
      - "fsync=on"                              # ‚úÖ OBLIGATORIO en producci√≥n
      - "-c"
      - "synchronous_commit=on"                 # ‚úÖ OBLIGATORIO en producci√≥n
      - "-c"
      - "full_page_writes=on"                   # ‚úÖ OBLIGATORIO en producci√≥n
    restart: unless-stopped  # ‚úÖ unless-stopped en producci√≥n (evita reinicio en shutdown manual)
    networks:
      - gmarm-network
    # üî• PRODUCCI√ìN: 2.5GB para PostgreSQL (M√ÅXIMA PRIORIDAD - DEV apagado)
    # Total asignado: 2.5GB + 768MB + 384MB = 3.65GB (de 3.8GB disponibles)
    mem_limit: 2.5g
    mem_reservation: 1g
    cpus: 2.0  # Prioridad m√°xima de CPU
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-gmarm_prod}"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"  # Mayor tama√±o para producci√≥n
        max-file: "10"    # M√°s archivos para auditor√≠a

volumes:
  postgres_data_prod:

networks:
  gmarm-network:
    driver: bridge
