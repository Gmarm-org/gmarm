# ========================================
# CONFIGURACIÓN POSTGRESQL PARA MÁXIMA ESTABILIDAD
# ========================================
# Optimizado para servidores con recursos limitados
# Objetivo: NUNCA caerse, priorizar estabilidad sobre performance

# ========================================
# CONFIGURACIÓN DE MEMORIA (CRÍTICO)
# ========================================
# Total memory budget: ~400MB (para no exceder el límite de 512MB del contenedor)

shared_buffers = 128MB                  # 25% de memoria disponible (conservador)
effective_cache_size = 256MB            # Estimado de cache del SO
work_mem = 2MB                          # Memoria por operación (MUY conservador)
maintenance_work_mem = 32MB             # Para VACUUM, CREATE INDEX, etc.
temp_buffers = 8MB                      # Buffers temporales por sesión

# ========================================
# CONEXIONES (CRÍTICO)
# ========================================
max_connections = 20                    # Reducido a 20 (cada conexión usa ~10MB)
superuser_reserved_connections = 3      # Conexiones reservadas para admin

# ========================================
# WAL (Write-Ahead Logging) - ESTABILIDAD
# ========================================
wal_buffers = 4MB                       # Buffers para WAL (conservador)
checkpoint_timeout = 10min              # Checkpoints cada 10 minutos
checkpoint_completion_target = 0.9      # Checkpoints suaves (90% del intervalo)
max_wal_size = 512MB                    # Máximo tamaño de WAL
min_wal_size = 80MB                     # Mínimo tamaño de WAL

# ========================================
# QUERY PLANNING
# ========================================
random_page_cost = 1.1                  # Asumiendo SSD
effective_io_concurrency = 200          # Para SSD
default_statistics_target = 50          # Reducido para ahorrar memoria

# ========================================
# AUTOVACUUM (CRÍTICO PARA ESTABILIDAD)
# ========================================
autovacuum = on                         # SIEMPRE activado
autovacuum_max_workers = 2              # Solo 2 workers para no sobrecargar
autovacuum_naptime = 1min               # Revisar cada minuto
autovacuum_vacuum_threshold = 50        # Vacuum después de 50 tuplas muertas
autovacuum_analyze_threshold = 50       # Analyze después de 50 cambios
autovacuum_vacuum_scale_factor = 0.1    # Vacuum al 10% de tuplas muertas
autovacuum_analyze_scale_factor = 0.05  # Analyze al 5% de cambios

# ========================================
# LOGGING (PARA DEBUGGING)
# ========================================
logging_collector = on
log_destination = 'stderr'
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# Logs de conexiones y desconexiones
log_connections = on
log_disconnections = on
log_duration = off

# Logs de errores y warnings
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000       # Log queries > 1 segundo

# Logs de checkpoints (para detectar problemas)
log_checkpoints = on
log_lock_waits = on                     # Log esperas de locks > deadlock_timeout

# ========================================
# TIMEOUTS Y DEADLOCKS
# ========================================
deadlock_timeout = 1s
statement_timeout = 300000              # 5 minutos máximo por query
lock_timeout = 30000                    # 30 segundos máximo esperando lock
idle_in_transaction_session_timeout = 600000  # 10 minutos máximo idle en transacción

# ========================================
# CONFIGURACIÓN DE KERNEL (PARA EVITAR OOM)
# ========================================
# Estas configuraciones ayudan a evitar que el kernel mate a PostgreSQL
huge_pages = off                        # Desactivar huge pages (puede causar OOM)
max_stack_depth = 2MB                   # Stack depth conservador

# ========================================
# CONFIGURACIÓN DE CLIENTE
# ========================================
# Encoding y locale
client_encoding = UTF8
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Timezone
timezone = 'America/Guayaquil'

# ========================================
# CONFIGURACIÓN DE SEGURIDAD
# ========================================
# Restringir acceso a funciones peligrosas
password_encryption = scram-sha-256

# ========================================
# CONFIGURACIÓN DE PERFORMANCE (SECUNDARIO)
# ========================================
# Solo si la estabilidad lo permite
synchronous_commit = on                 # Mantener ON para durabilidad
wal_sync_method = fdatasync            # Método más confiable
full_page_writes = on                   # Protección contra corrupción
wal_log_hints = on                     # Para pg_rewind

# ========================================
# LÍMITES DE RECURSOS
# ========================================
max_files_per_process = 1000
max_locks_per_transaction = 64
max_pred_locks_per_transaction = 64

# ========================================
# BACKGROUND WRITER (PARA EVITAR PICOS DE I/O)
# ========================================
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# ========================================
# QUERY CACHE (PLAN CACHE)
# ========================================
shared_preload_libraries = ''

# ========================================
# FIN DE CONFIGURACIÓN
# ========================================

